# Importar TransferConfig al inicio del módulo
using module "Q:\Utilidad\LLevar\Modules\Core\TransferConfig.psm1"

# ========================================================================== #
#                    MÓDULO: MENÚS DE CONFIGURACIÓN                          #
# ========================================================================== #
# Propósito: Menús de alto nivel para configuración de Llevar.ps1
# Funciones:
#   - Show-MainMenu: Menú principal de la aplicación
#   - Show-OrigenMenu: Configuración de origen
#   - Show-DestinoMenu: Configuración de destino  
#   - Show-BlockSizeMenu: Configuración de tamaño de bloque
#   - Show-PasswordMenu: Configuración de contraseña
#   - Show-IsoMenu: Configuración de generación ISO
# ========================================================================== #

function Show-MainMenu {
    <#
    .SYNOPSIS
        Menú principal interactivo de Llevar.ps1
    #>
    
    # Crear instancia de TransferConfig (la única fuente de verdad)
    $config = [TransferConfig]::new()
    
    while ($true) {
        # Construir display del origen desde TransferConfig
        $origenDisplay = $config.Origen.Tipo
        $origenPath = Get-TransferConfigOrigenPath -Config $config
        if ($origenPath) {
            $origenDisplay += " → $origenPath"
        }
        
        # Construir display del destino desde TransferConfig
        $destinoDisplay = $config.Destino.Tipo
        $destinoPath = Get-TransferConfigDestinoPath -Config $config
        if ($destinoPath) {
            $destinoDisplay += " → $destinoPath"
        }
        
        $options = @(
            "*Origen: $origenDisplay",
            "*Destino: $destinoDisplay",
            "*Tamaño de Bloque: $($config.Opciones.BlockSizeMB) MB",
            "Modo *Robocopy Mirror",
            "Generar *ISO (en lugar de USB)",
            "Usar ZIP *Nativo (sin 7-Zip)",
            "Configurar Con*traseña",
            "Modo *Ejemplo (Demo)",
            "*Ayuda",
            "*Ejecutar Transferencia....LLEVAR =)"
        )
        
        $selection = Show-DosMenu -Title "LLEVAR - MENÚ PRINCIPAL" -Items $options -CancelValue 0
        
        switch ($selection) {
            0 { return $null }  # Salir
            1 { $config = Show-OrigenMenu -Config $config }
            2 { $config = Show-DestinoMenu -Config $config }
            3 { $config = Show-BlockSizeMenu -Config $config }
            4 { 
                $config.Opciones.RobocopyMirror = -not $config.Opciones.RobocopyMirror
                if ($config.Opciones.RobocopyMirror) { 
                    Show-ConsolePopup -Title "Robocopy Mirror" -Message "Modo Robocopy Mirror activado`n`nSincronizará origen con destino (elimina extras)" -Options @("*OK") | Out-Null 
                }
            }
            5 { $config = Show-IsoMenu -Config $config }
            6 { 
                $config.Opciones.UseNativeZip = -not $config.Opciones.UseNativeZip
                Show-ConsolePopup -Title "ZIP Nativo" -Message "ZIP Nativo: $(if($config.Opciones.UseNativeZip){'ACTIVADO'}else{'DESACTIVADO'})" -Options @("*OK") | Out-Null 
            }
            7 { $config = Show-PasswordMenu -Config $config }
            8 { return @{ Action = "Example" } }
            9 { return @{ Action = "Help" } }
            10 { 
                # Validar configuración completa usando la función de TransferConfig
                $validation = Test-TransferConfigComplete -Config $config
                
                if (-not $validation.IsValid) {
                    $mensaje = "Faltan parámetros requeridos:`n`n" + ($validation.Errors -join "`n")
                    Show-ConsolePopup -Title "Configuración Incompleta" -Message $mensaje -Options @("*OK") | Out-Null
                    continue
                }
                
                # Retornar TransferConfig configurado
                return @{ 
                    Action         = "Execute"
                    TransferConfig = $config
                }
            }
        }
    }
}

function Show-OrigenMenu {
    <#
    .SYNOPSIS
        Menú de configuración de origen usando TransferConfig
    #>
    param([TransferConfig]$Config)
    
    $options = @(
        "*Local (carpeta del sistema)",
        "*FTP (servidor FTP)",
        "*OneDrive (Microsoft OneDrive)",
        "*Dropbox",
        "*UNC (red compartida)"
    )
    
    $selection = Show-DosMenu -Title "ORIGEN - Seleccione tipo" -Items $options -CancelValue 0
    
    switch ($selection) {
        0 { return $Config }
        1 {
            $selected = Select-LlevarFolder "Seleccione carpeta de ORIGEN"
            if ($selected) {
                Set-TransferConfigOrigen -Config $Config -Tipo "Local" -Parametros @{ Path = $selected }
            }
        }
        2 {
            $ftpConfig = Get-FtpConfigFromUser -Purpose "ORIGEN"
            if ($ftpConfig) {
                Set-TransferConfigOrigen -Config $Config -Tipo "FTP" -Parametros @{
                    Server    = $ftpConfig.Server
                    Port      = $ftpConfig.Port
                    Directory = $ftpConfig.Directory
                    User      = $ftpConfig.User
                    Password  = $ftpConfig.Password
                }
            }
        }
        3 {
            $authResult = Get-OneDriveAuth
            if ($authResult) {
                if ($authResult.UseLocal) {
                    Set-TransferConfigOrigen -Config $Config -Tipo "Local" -Parametros @{ Path = $authResult.LocalPath }
                }
                else {
                    Write-Host "`nIngrese la ruta en OneDrive (ej: /Documentos/MiCarpeta):" -ForegroundColor Cyan
                    Write-Host "Presione ENTER para ruta raíz (/)" -ForegroundColor Gray
                    $path = Read-Host "Ruta"
                    if ([string]::IsNullOrWhiteSpace($path)) { $path = "/" }
                    
                    Set-TransferConfigOrigen -Config $Config -Tipo "OneDrive" -Parametros @{
                        Path         = $path
                        Token        = $authResult.Token
                        RefreshToken = $authResult.RefreshToken
                        Email        = $authResult.Email
                    }
                }
            }
        }
        4 {
            $authResult = Get-DropboxAuth
            if ($authResult) {
                if ($authResult.UseLocal) {
                    Set-TransferConfigOrigen -Config $Config -Tipo "Local" -Parametros @{ Path = $authResult.LocalPath }
                }
                else {
                    Write-Host "`nIngrese la ruta en Dropbox (ej: /Documentos/MiCarpeta):" -ForegroundColor Cyan
                    Write-Host "Presione ENTER para ruta raíz (/)" -ForegroundColor Gray
                    $path = Read-Host "Ruta"
                    if ([string]::IsNullOrWhiteSpace($path)) { $path = "/" }
                    
                    Set-TransferConfigOrigen -Config $Config -Tipo "Dropbox" -Parametros @{
                        Path         = $path
                        Token        = $authResult.Token
                        RefreshToken = $authResult.RefreshToken
                        Email        = $authResult.Email
                    }
                }
            }
        }
        5 {
            $uncResult = Select-NetworkPath -Purpose "ORIGEN"
            if ($uncResult) {
                Set-TransferConfigOrigen -Config $Config -Tipo "UNC" -Parametros @{
                    Path        = $uncResult.Path
                    Credentials = $uncResult.Credentials
                }
            }
        }
    }
    
    return $Config
}

function Show-DestinoMenu {
    <#
    .SYNOPSIS
        Menú de configuración de destino usando TransferConfig
    #>
    param([TransferConfig]$Config)
    
    $options = @(
        "*Local (carpeta del sistema)",
        "*USB (copiar a dispositivos USB)",
        "*Diskettes (disquetes 1.44MB)",
        "*FTP (servidor FTP)",
        "*OneDrive (Microsoft OneDrive)",
        "*Dropbox",
        "U*NC (red compartida)"
    )
    
    $selection = Show-DosMenu -Title "DESTINO - Seleccione tipo" -Items $options -CancelValue 0
    
    switch ($selection) {
        0 { return $Config }
        1 {
            $selected = Select-LlevarFolder "Seleccione carpeta de DESTINO"
            if ($selected) {
                Set-TransferConfigDestino -Config $Config -Tipo "Local" -Parametros @{ Path = $selected }
            }
        }
        2 {
            Show-ConsolePopup -Title "Modo USB" -Message "El programa solicitará USBs durante la transferencia" -Options @("*OK") | Out-Null
            Set-TransferConfigDestino -Config $Config -Tipo "USB" -Parametros @{ Path = "USB" }
        }
        3 {
            if (-not (Test-FloppyDriveAvailable)) {
                Show-ConsolePopup -Title "Error" -Message "No se detectó una unidad de diskette (A:) en el sistema.`n`nLos diskettes son tecnología obsoleta. Se recomienda usar USB o ISO." -Options @("*OK") | Out-Null
                return $Config
            }
            
            $mensaje = @"
⚠ MODO DISKETTES (LEGACY)

Los diskettes de 1.44MB son medios obsoletos y poco confiables.
Este modo existe solo por compatibilidad histórica.

Características:
• Capacidad: 1.44 MB por diskette
• Máximo: 30 diskettes
• Formateo automático
• Verificación de integridad

¿Desea continuar con diskettes?
"@
            
            $confirmOptions = @("*Sí, usar diskettes", "*No, elegir otro destino")
            $confirm = Show-ConsolePopup -Title "Confirmación" -Message $mensaje -Options $confirmOptions
            
            if ($confirm -eq 0) {
                Set-TransferConfigDestino -Config $Config -Tipo "Diskette" -Parametros @{ 
                    OutputPath = $env:TEMP
                    MaxDisks   = 30
                }
                Show-ConsolePopup -Title "Modo Diskette" -Message "El programa solicitará diskettes durante la transferencia.`nAsegúrese de tener suficientes diskettes vacíos." -Options @("*OK") | Out-Null
            }
        }
        4 {
            $ftpConfig = Get-FtpConfigFromUser -Purpose "DESTINO"
            if ($ftpConfig) {
                Set-TransferConfigDestino -Config $Config -Tipo "FTP" -Parametros @{
                    Server    = $ftpConfig.Server
                    Port      = $ftpConfig.Port
                    Directory = $ftpConfig.Directory
                    User      = $ftpConfig.User
                    Password  = $ftpConfig.Password
                }
            }
        }
        5 {
            $authResult = Get-OneDriveAuth
            if ($authResult) {
                if ($authResult.UseLocal) {
                    Set-TransferConfigDestino -Config $Config -Tipo "Local" -Parametros @{ Path = $authResult.LocalPath }
                }
                else {
                    Write-Host "`nIngrese la ruta en OneDrive (ej: /Backups/MiCarpeta):" -ForegroundColor Cyan
                    Write-Host "Presione ENTER para ruta raíz (/)" -ForegroundColor Gray
                    $path = Read-Host "Ruta"
                    if ([string]::IsNullOrWhiteSpace($path)) { $path = "/" }
                    
                    Set-TransferConfigDestino -Config $Config -Tipo "OneDrive" -Parametros @{
                        Path         = $path
                        Token        = $authResult.Token
                        RefreshToken = $authResult.RefreshToken
                        Email        = $authResult.Email
                    }
                }
            }
        }
        6 {
            $authResult = Get-DropboxAuth
            if ($authResult) {
                if ($authResult.UseLocal) {
                    Set-TransferConfigDestino -Config $Config -Tipo "Local" -Parametros @{ Path = $authResult.LocalPath }
                }
                else {
                    Write-Host "`nIngrese la ruta en Dropbox (ej: /Backups/MiCarpeta):" -ForegroundColor Cyan
                    Write-Host "Presione ENTER para ruta raíz (/)" -ForegroundColor Gray
                    $path = Read-Host "Ruta"
                    if ([string]::IsNullOrWhiteSpace($path)) { $path = "/" }
                    
                    Set-TransferConfigDestino -Config $Config -Tipo "Dropbox" -Parametros @{
                        Path         = $path
                        Token        = $authResult.Token
                        RefreshToken = $authResult.RefreshToken
                        Email        = $authResult.Email
                    }
                }
            }
        }
        7 {
            $uncResult = Select-NetworkPath -Purpose "DESTINO"
            if ($uncResult) {
                Set-TransferConfigDestino -Config $Config -Tipo "UNC" -Parametros @{
                    Path        = $uncResult.Path
                    Credentials = $uncResult.Credentials
                }
            }
        }
    }
    
    return $Config
}

function Show-BlockSizeMenu {
    <#
    .SYNOPSIS
        Menú de configuración de tamaño de bloque usando TransferConfig
    #>
    param([TransferConfig]$Config)
    
    $options = @(
        "*1.44 MB (diskette)",
        "*10 MB (USBs pequeños)",
        "*50 MB (USBs medianos)",
        "*100 MB (USBs grandes)",
        "*500 MB (discos externos)",
        "*1000 MB / 1 GB (discos grandes)",
        "Tamaño *Manual (ingresar valor)"
    )
    
    $currentSize = $Config.Opciones.BlockSizeMB
    $selection = Show-DosMenu -Title "TAMAÑO DE BLOQUE (Actual: $currentSize MB)" -Items $options -CancelValue 0
    
    switch ($selection) {
        0 { return $Config }
        1 { 
            $Config.Opciones.BlockSizeMB = 1.44
            Show-ConsolePopup -Title "Tamaño de Bloque" -Message "Configurado: 1.44 MB (diskette)`n`n⚠ Solo compatible con 7-Zip`n(ZIP nativo no soporta tamaños menores a 2 MB)" -Options @("*OK") | Out-Null
        }
        2 { 
            $Config.Opciones.BlockSizeMB = 10
            Show-ConsolePopup -Title "Tamaño de Bloque" -Message "Configurado: 10 MB" -Options @("*OK") | Out-Null
        }
        3 { 
            $Config.Opciones.BlockSizeMB = 50
            Show-ConsolePopup -Title "Tamaño de Bloque" -Message "Configurado: 50 MB" -Options @("*OK") | Out-Null
        }
        4 { 
            $Config.Opciones.BlockSizeMB = 100
            Show-ConsolePopup -Title "Tamaño de Bloque" -Message "Configurado: 100 MB" -Options @("*OK") | Out-Null
        }
        5 { 
            $Config.Opciones.BlockSizeMB = 500
            Show-ConsolePopup -Title "Tamaño de Bloque" -Message "Configurado: 500 MB" -Options @("*OK") | Out-Null
        }
        6 { 
            $Config.Opciones.BlockSizeMB = 1000
            Show-ConsolePopup -Title "Tamaño de Bloque" -Message "Configurado: 1000 MB (1 GB)" -Options @("*OK") | Out-Null
        }
        7 {
            Show-Banner "TAMAÑO MANUAL" -BorderColor Cyan -TextColor Yellow
            Write-Host ""
            Write-Host "Tamaño actual: $($Config.Opciones.BlockSizeMB) MB" -ForegroundColor Cyan
            Write-Host ""
            Write-Host "Límites según compresor:" -ForegroundColor Gray
            Write-Host "  • 7-Zip:      0.001 MB - 2048 MB (2 GB)" -ForegroundColor DarkGray
            Write-Host "  • ZIP Nativo: 2 MB - 2048 MB (2 GB)" -ForegroundColor DarkGray
            Write-Host ""
            Write-Host "Ingrese tamaño en MB (ENTER para cancelar): " -NoNewline -ForegroundColor Cyan
            $userInput = Read-Host
            
            if (-not [string]::IsNullOrWhiteSpace($userInput)) {
                $newSize = 0.0
                if ([double]::TryParse($userInput, [ref]$newSize)) {
                    if ($newSize -le 0) {
                        Show-ConsolePopup -Title "Error" -Message "El tamaño debe ser mayor a 0 MB" -Options @("*OK") | Out-Null
                    }
                    elseif ($newSize -gt 2048) {
                        Show-ConsolePopup -Title "Error" -Message "El tamaño máximo es 2048 MB (2 GB)" -Options @("*OK") | Out-Null
                    }
                    elseif ($newSize -lt 2 -and $Config.Opciones.UseNativeZip) {
                        Show-ConsolePopup -Title "Error" -Message "ZIP nativo requiere mínimo 2 MB`n`nUse 7-Zip para tamaños menores o aumente el tamaño." -Options @("*OK") | Out-Null
                    }
                    else {
                        $Config.Opciones.BlockSizeMB = $newSize
                        
                        $mensaje = "Tamaño configurado: $newSize MB"
                        if ($newSize -lt 2) {
                            $mensaje += "`n`n⚠ Requiere 7-Zip (ZIP nativo no soporta tamaños menores a 2 MB)"
                        }
                        
                        Show-ConsolePopup -Title "Tamaño de Bloque" -Message $mensaje -Options @("*OK") | Out-Null
                    }
                }
                else {
                    Show-ConsolePopup -Title "Error" -Message "Valor inválido. Ingrese un número decimal válido.`n`nEjemplo: 1.44 o 10.5" -Options @("*OK") | Out-Null
                }
            }
        }
    }
    
    return $Config
}

function Show-PasswordMenu {
    <#
    .SYNOPSIS
        Menú de configuración de contraseña usando TransferConfig
    #>
    param([TransferConfig]$Config)
    
    if ($Config.Opciones.Clave) {
        $options = @(
            "*Cambiar contraseña",
            "*Eliminar contraseña"
        )
        $selection = Show-DosMenu -Title "CONTRASEÑA (Actual: ******)" -Items $options -CancelValue 0
        
        if ($selection -eq 0) { return $Config }
        if ($selection -eq 2) {
            $Config.Opciones.Clave = $null
            Show-ConsolePopup -Title "Contraseña" -Message "Contraseña eliminada" -Options @("*OK") | Out-Null
            return $Config
        }
    }
    
    Show-Banner "CONFIGURAR CONTRASEÑA" -BorderColor Cyan -TextColor Yellow
    Write-Host "⚠ NOTA: Solo funciona con 7-Zip (no con ZIP nativo)" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "Ingrese contraseña (ENTER para cancelar): " -NoNewline -ForegroundColor Cyan
    $pass1 = Read-Host -AsSecureString
    
    if ($pass1.Length -eq 0) {
        return $Config
    }
    
    Write-Host "Confirme contraseña: " -NoNewline -ForegroundColor Cyan
    $pass2 = Read-Host -AsSecureString
    
    $ptr1 = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($pass1)
    $ptr2 = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($pass2)
    $plainPass1 = [System.Runtime.InteropServices.Marshal]::PtrToStringBSTR($ptr1)
    $plainPass2 = [System.Runtime.InteropServices.Marshal]::PtrToStringBSTR($ptr2)
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($ptr1)
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($ptr2)
    
    if ($plainPass1 -eq $plainPass2) {
        $Config.Opciones.Clave = $plainPass1
        Show-ConsolePopup -Title "Contraseña" -Message "Contraseña configurada correctamente" -Options @("*OK") | Out-Null
    }
    else {
        Show-ConsolePopup -Title "Error" -Message "Las contraseñas no coinciden" -Options @("*OK") | Out-Null
    }
    
    return $Config
}

function Show-IsoMenu {
    <#
    .SYNOPSIS
        Menú de configuración ISO usando TransferConfig
    #>
    param([TransferConfig]$Config)
    
    # Toggle ISO mode
    $wasISO = ($Config.Destino.Tipo -eq "ISO")
    
    if (-not $wasISO) {
        $options = @(
            "*CD (700 MB)",
            "*DVD (4.5 GB)",
            "*USB (4.5 GB)"
        )
        
        $selection = Show-DosMenu -Title "TIPO DE ISO" -Items $options -CancelValue 0 -DefaultValue 2
        
        if ($selection -eq 0) { 
            return $Config 
        }
        
        $isoSize = switch ($selection) {
            1 { "cd" }
            2 { "dvd" }
            3 { "usb" }
        }
        
        # Configurar destino como ISO
        Set-TransferConfigDestino -Config $Config -Tipo "ISO" -Parametros @{
            OutputPath = $env:TEMP
            Size       = $isoSize
        }
        
        Show-ConsolePopup -Title "Modo ISO" -Message "Se generarán imágenes ISO de tipo: $($isoSize.ToUpper())" -Options @("*OK") | Out-Null
    }
    else {
        # Desactivar ISO - volver a Local por defecto
        Set-TransferConfigDestino -Config $Config -Tipo "Local" -Parametros @{ Path = $null }
        Show-ConsolePopup -Title "Modo ISO" -Message "Modo ISO desactivado" -Options @("*OK") | Out-Null
    }
    
    return $Config
}

# Exportar funciones
Export-ModuleMember -Function @(
    'Show-MainMenu',
    'Show-OrigenMenu',
    'Show-DestinoMenu',
    'Show-BlockSizeMenu',
    'Show-PasswordMenu',
    'Show-IsoMenu'
)
