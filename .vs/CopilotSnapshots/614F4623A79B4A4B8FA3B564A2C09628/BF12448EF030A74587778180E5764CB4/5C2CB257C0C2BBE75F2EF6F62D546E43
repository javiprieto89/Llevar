# ========================================================================== #
#           PRUEBA INTEGRAL DE REFACTORIZACIÓN TRANSFERCONFIG               #
# ========================================================================== #
# Archivo: Tests\Test-RefactorizacionCompleta.ps1
# Propósito: Validar que la refactorización funciona correctamente
# ========================================================================== #

using module "Q:\Utilidad\LLevar\Modules\Core\TransferConfig.psm1"

Write-Host "════════════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host "    PRUEBA INTEGRAL - REFACTORIZACIÓN TRANSFERCONFIG" -ForegroundColor Yellow
Write-Host "════════════════════════════════════════════════════════════" -ForegroundColor Cyan
Write-Host ""

# ========================================================================== #
#                          PRUEBA 1: INSTANCIACIÓN                           #
# ========================================================================== #

Write-Host "[PRUEBA 1] Creando instancia de TransferConfig..." -ForegroundColor Cyan

try {
    $llevar = [TransferConfig]::new()
    
    Write-Host "✓ Instancia creada correctamente" -ForegroundColor Green
    Write-Host "  Tipo: $($llevar.GetType().FullName)" -ForegroundColor Gray
    Write-Host "  Origen.Tipo: $($llevar.Origen.Tipo)" -ForegroundColor Gray
    Write-Host "  Destino.Tipo: $($llevar.Destino.Tipo)" -ForegroundColor Gray
    Write-Host "  Opciones.BlockSizeMB: $($llevar.Opciones.BlockSizeMB)" -ForegroundColor Gray
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#                  PRUEBA 2: MODIFICACIÓN DIRECTA (ORIGEN FTP)               #
# ========================================================================== #

Write-Host "[PRUEBA 2] Modificando Origen FTP directamente..." -ForegroundColor Cyan

try {
    # Simular configuración FTP en Origen
    $llevar.Origen.Tipo = "FTP"
    $llevar.Origen.FTP.Server = "ftp://test.rebex.net"
    $llevar.Origen.FTP.Port = 21
    $llevar.Origen.FTP.User = "demo"
    $llevar.Origen.FTP.Password = "password"
    $llevar.Origen.FTP.Directory = "/pub"
    $llevar.Origen.FTP.UseSsl = $false
    
    Write-Host "✓ Origen FTP configurado" -ForegroundColor Green
    Write-Host "  Server: $($llevar.Origen.FTP.Server)" -ForegroundColor Gray
    Write-Host "  Port: $($llevar.Origen.FTP.Port)" -ForegroundColor Gray
    Write-Host "  User: $($llevar.Origen.FTP.User)" -ForegroundColor Gray
    Write-Host "  Directory: $($llevar.Origen.FTP.Directory)" -ForegroundColor Gray
    Write-Host ""
    
    # Verificar que NO se pisó Destino ni Opciones
    if ($llevar.Destino.Tipo -eq "" -and $llevar.Opciones.BlockSizeMB -eq 10) {
        Write-Host "✓ Destino y Opciones NO fueron modificados" -ForegroundColor Green
        Write-Host "  Destino.Tipo: (vacío)" -ForegroundColor Gray
        Write-Host "  Opciones.BlockSizeMB: $($llevar.Opciones.BlockSizeMB)" -ForegroundColor Gray
    }
    else {
        Write-Host "✗ ERROR: Se pisaron valores no relacionados" -ForegroundColor Red
        exit 1
    }
    
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#              PRUEBA 3: MODIFICACIÓN INDEPENDIENTE (DESTINO LOCAL)          #
# ========================================================================== #

Write-Host "[PRUEBA 3] Modificando Destino Local (sin pisar Origen)..." -ForegroundColor Cyan

try {
    # Simular configuración Local en Destino
    $llevar.Destino.Tipo = "Local"
    $llevar.Destino.Local.Path = "C:\Temp\Backup"
    
    Write-Host "✓ Destino Local configurado" -ForegroundColor Green
    Write-Host "  Tipo: $($llevar.Destino.Tipo)" -ForegroundColor Gray
    Write-Host "  Path: $($llevar.Destino.Local.Path)" -ForegroundColor Gray
    Write-Host ""
    
    # Verificar que Origen FTP sigue intacto
    if ($llevar.Origen.Tipo -eq "FTP" -and $llevar.Origen.FTP.Server -eq "ftp://test.rebex.net") {
        Write-Host "✓ Origen FTP NO fue pisado" -ForegroundColor Green
        Write-Host "  Origen.Tipo: $($llevar.Origen.Tipo)" -ForegroundColor Gray
        Write-Host "  Origen.FTP.Server: $($llevar.Origen.FTP.Server)" -ForegroundColor Gray
    }
    else {
        Write-Host "✗ ERROR: Origen FTP fue modificado incorrectamente" -ForegroundColor Red
        exit 1
    }
    
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#                   PRUEBA 4: MODIFICACIÓN DE OPCIONES                       #
# ========================================================================== #

Write-Host "[PRUEBA 4] Modificando Opciones (sin pisar Origen/Destino)..." -ForegroundColor Cyan

try {
    # Modificar opciones
    $llevar.Opciones.BlockSizeMB = 50
    $llevar.Opciones.Clave = "MiPassword123"
    $llevar.Opciones.UseNativeZip = $true
    
    Write-Host "✓ Opciones modificadas" -ForegroundColor Green
    Write-Host "  BlockSizeMB: $($llevar.Opciones.BlockSizeMB)" -ForegroundColor Gray
    Write-Host "  Clave: ********" -ForegroundColor Gray
    Write-Host "  UseNativeZip: $($llevar.Opciones.UseNativeZip)" -ForegroundColor Gray
    Write-Host ""
    
    # Verificar que Origen y Destino siguen intactos
    if ($llevar.Origen.Tipo -eq "FTP" -and $llevar.Destino.Tipo -eq "Local") {
        Write-Host "✓ Origen y Destino NO fueron modificados" -ForegroundColor Green
        Write-Host "  Origen.Tipo: $($llevar.Origen.Tipo)" -ForegroundColor Gray
        Write-Host "  Destino.Tipo: $($llevar.Destino.Tipo)" -ForegroundColor Gray
    }
    else {
        Write-Host "✗ ERROR: Origen/Destino fueron modificados incorrectamente" -ForegroundColor Red
        exit 1
    }
    
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#                   PRUEBA 5: PUERTO POR DEFECTO FTP                         #
# ========================================================================== #

Write-Host "[PRUEBA 5] Verificando puerto por defecto FTP..." -ForegroundColor Cyan

try {
    # Crear nueva instancia para probar puerto por defecto
    $llevarNuevo = [TransferConfig]::new()
    
    # Simular que usuario configuró FTP sin especificar puerto
    # (debe usar el puerto inicializado en TransferConfig)
    $puertoInicial = if ($llevarNuevo.Origen.FTP.Port -gt 0) { $llevarNuevo.Origen.FTP.Port } else { 21 }
    
    Write-Host "✓ Puerto por defecto detectado: $puertoInicial" -ForegroundColor Green
    
    # Ahora simular que usuario ingresó puerto manualmente
    $llevarNuevo.Origen.FTP.Port = 2121
    
    Write-Host "✓ Puerto modificado manualmente: $($llevarNuevo.Origen.FTP.Port)" -ForegroundColor Green
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#                   PRUEBA 6: VALIDACIÓN COMPLETA                            #
# ========================================================================== #

Write-Host "[PRUEBA 6] Validando configuración completa..." -ForegroundColor Cyan

try {
    $validation = Test-TransferConfigComplete -Config $llevar
    
    if ($validation.IsValid) {
        Write-Host "✓ Configuración válida y completa" -ForegroundColor Green
        Write-Host "  Origen: $($llevar.Origen.Tipo)" -ForegroundColor Gray
        Write-Host "  Destino: $($llevar.Destino.Tipo)" -ForegroundColor Gray
        Write-Host "  BlockSizeMB: $($llevar.Opciones.BlockSizeMB)" -ForegroundColor Gray
    }
    else {
        Write-Host "⚠ Configuración incompleta (esperado en prueba)" -ForegroundColor Yellow
        Write-Host "  Errores: $($validation.Errors -join ', ')" -ForegroundColor Gray
    }
    
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#                   PRUEBA 7: OBTENER PATHS COMPLETOS                        #
# ========================================================================== #

Write-Host "[PRUEBA 7] Obteniendo paths completos..." -ForegroundColor Cyan

try {
    $origenPath = Get-TransferConfigOrigenPath -Config $llevar
    $destinoPath = Get-TransferConfigDestinoPath -Config $llevar
    
    Write-Host "✓ Paths obtenidos correctamente" -ForegroundColor Green
    Write-Host "  Origen Path: $origenPath" -ForegroundColor Gray
    Write-Host "  Destino Path: $destinoPath" -ForegroundColor Gray
    Write-Host ""
}
catch {
    Write-Host "✗ ERROR: $_" -ForegroundColor Red
    exit 1
}

# ========================================================================== #
#                          RESUMEN FINAL                                     #
# ========================================================================== #

Write-Host "════════════════════════════════════════════════════════════" -ForegroundColor Green
Write-Host "           ✓ TODAS LAS PRUEBAS COMPLETADAS EXITOSAMENTE" -ForegroundColor Green
Write-Host "════════════════════════════════════════════════════════════" -ForegroundColor Green
Write-Host ""

Write-Host "CONFIGURACIÓN FINAL DE `$llevar:" -ForegroundColor Yellow
Write-Host "  Origen.Tipo: $($llevar.Origen.Tipo)" -ForegroundColor White
Write-Host "  Origen.FTP.Server: $($llevar.Origen.FTP.Server)" -ForegroundColor White
Write-Host "  Origen.FTP.Port: $($llevar.Origen.FTP.Port)" -ForegroundColor White
Write-Host "  Destino.Tipo: $($llevar.Destino.Tipo)" -ForegroundColor White
Write-Host "  Destino.Local.Path: $($llevar.Destino.Local.Path)" -ForegroundColor White
Write-Host "  Opciones.BlockSizeMB: $($llevar.Opciones.BlockSizeMB)" -ForegroundColor White
Write-Host "  Opciones.UseNativeZip: $($llevar.Opciones.UseNativeZip)" -ForegroundColor White
Write-Host ""

Write-Host "✅ REFACTORIZACIÓN VALIDADA CORRECTAMENTE" -ForegroundColor Green
Write-Host ""

exit 0
