# ========================================================================== #
#                         MÓDULO: OPERACIONES ONEDRIVE                       #
# ========================================================================== #
# Propósito: Configuración, validación y operaciones con OneDrive
# Funciones refactorizadas para usar TransferConfig como única fuente de verdad
# ========================================================================== #

# Importar TransferConfig al inicio
using module "Q:\Utilidad\LLevar\Modules\Core\TransferConfig.psm1"

# Imports necesarios
$ModulesPath = Split-Path (Split-Path $PSScriptRoot -Parent) -Parent
Import-Module (Join-Path $ModulesPath "Modules\UI\Banners.psm1") -Force -Global
Import-Module (Join-Path $ModulesPath "Modules\UI\ProgressBar.psm1") -Force -Global
Import-Module (Join-Path $ModulesPath "Modules\Core\Logging.psm1") -Force -Global

# ========================================================================== #
#                          FUNCIONES AUXILIARES                              #
# ========================================================================== #

function Test-IsOneDrivePath {
    <#
    .SYNOPSIS
        Detecta si una ruta es OneDrive
    .PARAMETER Path
        Ruta a verificar
    .OUTPUTS
        $true si es OneDrive, $false si no
    #>
    param([string]$Path)
    return $Path -match '^onedrive://|^ONEDRIVE:'
}

function Get-OneDriveConfigFromUser {
    <#
    .SYNOPSIS
        Solicita configuración OneDrive al usuario y la asigna directamente al objeto Llevar
    .DESCRIPTION
        Muestra menú para configurar OneDrive (local o API).
        Valida la conexión y asigna SOLO los valores OneDrive a:
        - $Llevar.Origen.Tipo = "OneDrive" + $Llevar.Origen.OneDrive.* si $Cual = "Origen"
        - $Llevar.Destino.Tipo = "OneDrive" + $Llevar.Destino.OneDrive.* si $Cual = "Destino"
        
        ✅ NO PISA otros valores del objeto $Llevar
    .PARAMETER Llevar
        Objeto TransferConfig donde se guardarán SOLO los valores OneDrive
    .PARAMETER Cual
        "Origen" o "Destino" - indica qué sección configurar
    .OUTPUTS
        $true si la configuración fue exitosa, $false si se canceló
    #>
    param(
        [Parameter(Mandatory = $true)]
        [TransferConfig]$Llevar,
        
        [Parameter(Mandatory = $true)]
        [ValidateSet("Origen", "Destino")]
        [string]$Cual
    )
    
    Show-Banner "CONFIGURACIÓN ONEDRIVE - $Cual" -BorderColor Cyan -TextColor Yellow
    
    # Verificar módulo Microsoft.Graph
    if (-not (Test-MicrosoftGraphModule)) {
        Write-Host "⚠ Módulo Microsoft.Graph no instalado" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "¿Desea instalarlo ahora? (S/N): " -NoNewline -ForegroundColor Cyan
        $respuesta = Read-Host
        
        if ($respuesta -eq 'S' -or $respuesta -eq 's') {
            try {
                Install-Module Microsoft.Graph -Scope CurrentUser -Force
                Write-Host "✓ Módulo instalado correctamente" -ForegroundColor Green
            }
            catch {
                Write-Host "✗ Error instalando módulo: $($_.Exception.Message)" -ForegroundColor Red
                return $false
            }
        }
        else {
            Write-Host "Configuración OneDrive cancelada" -ForegroundColor Yellow
            return $false
        }
    }
    
    # Autenticar con OneDrive
    Write-Host ""
    Write-Host "Autenticando con OneDrive..." -ForegroundColor Cyan
    Write-Log "Intentando autenticar OneDrive para $Cual" "INFO"
    
    try {
        $authResult = Get-OneDriveAuth
        
        if (-not $authResult) {
            Write-Host "✗ Autenticación cancelada" -ForegroundColor Red
            return $false
        }
        
        Write-Host "✓ Autenticación exitosa" -ForegroundColor Green
        Write-Host ""
        
        # Solicitar ruta OneDrive
        Write-Host "Ruta en OneDrive (ej: /Documentos/MiCarpeta): " -NoNewline -ForegroundColor Cyan
        $onedriv ePath = Read-Host
        
        if ([string]::IsNullOrWhiteSpace($onedrivePath)) {
            $onedrivePath = "/"
        }
        elseif (-not $onedrivePath.StartsWith('/')) {
            $onedrivePath = "/$onedrivePath"
        }
        
        Write-Host ""
        Write-Host "✓ Ruta configurada: $onedrivePath" -ForegroundColor Green
        
    }
    catch {
        $errorMsg = $_.Exception.Message
        Show-Banner "⚠ ERROR DE AUTENTICACIÓN ONEDRIVE" -BorderColor Red -TextColor Red
        Write-Host "Error: $errorMsg" -ForegroundColor Yellow
        Write-Host ""
        Write-Log "Error autenticación OneDrive - $errorMsg" "ERROR" -ErrorRecord $_
        return $false
    }
    
    # ✅✅✅ ASIGNAR SOLO LA SECCIÓN ONEDRIVE CORRESPONDIENTE
    if ($Cual -eq "Origen") {
        $Llevar.Origen.Tipo = "OneDrive"
        $Llevar.Origen.OneDrive.Path = $onedrivePath
        $Llevar.Origen.OneDrive.Token = $authResult.Token
        $Llevar.Origen.OneDrive.RefreshToken = $authResult.RefreshToken
        $Llevar.Origen.OneDrive.Email = $authResult.Email
        $Llevar.Origen.OneDrive.ApiUrl = $authResult.ApiUrl
        
        Write-Log "OneDrive Origen configurado: $onedrivePath (Usuario: $($authResult.Email))" "INFO"
    }
    else {
        $Llevar.Destino.Tipo = "OneDrive"
        $Llevar.Destino.OneDrive.Path = $onedrivePath
        $Llevar.Destino.OneDrive.Token = $authResult.Token
        $Llevar.Destino.OneDrive.RefreshToken = $authResult.RefreshToken
        $Llevar.Destino.OneDrive.Email = $authResult.Email
        $Llevar.Destino.OneDrive.ApiUrl = $authResult.ApiUrl
        
        Write-Log "OneDrive Destino configurado: $onedrivePath (Usuario: $($authResult.Email))" "INFO"
    }
    
    Write-Host ""
    Write-Host "✓ Configuración OneDrive guardada en \$Llevar.$Cual.OneDrive" -ForegroundColor Green
    Write-Host ""
    
    return $true
}

# ========================================================================== #
#                  FUNCIONES PRINCIPALES DE TRANSFERENCIA                    #
# ========================================================================== #

function Copy-LlevarLocalToOneDrive {
    <#
    .SYNOPSIS
        Copia archivos locales a OneDrive con progreso
    .PARAMETER Llevar
        Objeto TransferConfig completo con origen y destino configurados
    .PARAMETER StartTime
        Tiempo de inicio para barra de progreso
    .PARAMETER ShowProgress
        Mostrar barra de progreso
    .PARAMETER ProgressTop
        Posición Y de la barra de progreso
    #>
    param(
        [Parameter(Mandatory = $true)]
        [TransferConfig]$Llevar,
        
        [datetime]$StartTime = (Get-Date),
        [bool]$ShowProgress = $true,
        [int]$ProgressTop = -1
    )
    
    # ✅ VALIDAR configuración
    if ($Llevar.Origen.Tipo -ne "Local") {
        throw "Origen debe ser tipo 'Local', recibido: $($Llevar.Origen.Tipo)"
    }
    
    if ($Llevar.Destino.Tipo -ne "OneDrive") {
        throw "Destino debe ser tipo 'OneDrive', recibido: $($Llevar.Destino.Tipo)"
    }
    
    # ✅ Extraer valores
    $sourcePath = $Llevar.Origen.Local.Path
    $token = $Llevar.Destino.OneDrive.Token
    $remotePath = $Llevar.Destino.OneDrive.Path
    
    # Validaciones
    if ([string]::IsNullOrWhiteSpace($sourcePath)) {
        throw "Origen.Local.Path no puede estar vacío"
    }
    
    if ([string]::IsNullOrWhiteSpace($token)) {
        throw "Destino.OneDrive.Token no puede estar vacío"
    }
    
    Write-Log "Copia Local → OneDrive: $sourcePath → $remotePath" "INFO"
    
    if ($ShowProgress) {
        Write-LlevarProgressBar -Percent 0 -StartTime $StartTime -Label "Subiendo a OneDrive..." -Top $ProgressTop -Width 50
    }
    
    # TODO: Implementación completa
    Write-Log "Copia Local → OneDrive: Funcionalidad en desarrollo" "WARNING"
    throw "Copia Local → OneDrive no implementada completamente."
}

function Copy-LlevarOneDriveToLocal {
    <#
    .SYNOPSIS
        Descarga archivos desde OneDrive a local con progreso
    .PARAMETER Llevar
        Objeto TransferConfig completo
    .PARAMETER StartTime
        Tiempo de inicio
    .PARAMETER ShowProgress
        Mostrar progreso
    .PARAMETER ProgressTop
        Posición Y
    #>
    param(
        [Parameter(Mandatory = $true)]
        [TransferConfig]$Llevar,
        
        [datetime]$StartTime = (Get-Date),
        [bool]$ShowProgress = $true,
        [int]$ProgressTop = -1
    )
    
    # ✅ VALIDAR
    if ($Llevar.Origen.Tipo -ne "OneDrive") {
        throw "Origen debe ser tipo 'OneDrive', recibido: $($Llevar.Origen.Tipo)"
    }
    
    if ($Llevar.Destino.Tipo -ne "Local") {
        throw "Destino debe ser tipo 'Local', recibido: $($Llevar.Destino.Tipo)"
    }
    
    # Extraer valores
    $token = $Llevar.Origen.OneDrive.Token
    $remotePath = $Llevar.Origen.OneDrive.Path
    $destPath = $Llevar.Destino.Local.Path
    
    Write-Log "Copia OneDrive → Local: $remotePath → $destPath" "INFO"
    
    if ($ShowProgress) {
        Write-LlevarProgressBar -Percent 0 -StartTime $StartTime -Label "Descargando de OneDrive..." -Top $ProgressTop -Width 50
    }
    
    # TODO: Implementación completa
    Write-Log "Copia OneDrive → Local: Funcionalidad en desarrollo" "WARNING"
    throw "Copia OneDrive → Local no implementada completamente."
}

# ========================================================================== #
#                         FUNCIONES LEGACY (OBSOLETAS)                       #
# ========================================================================== #

function Get-OneDriveAuth {
    <#
    .SYNOPSIS
        [FUNCIÓN AUXILIAR] Obtiene autenticación OneDrive
    .DESCRIPTION
        Esta función es auxiliar y se usa internamente.
        NO modificar sin coordinar con Get-OneDriveConfigFromUser.
    #>
    # Implementación simplificada - retornar mock por ahora
    return @{
        Token        = "mock_token"
        RefreshToken = "mock_refresh"
        Email        = "user@example.com"
        ApiUrl       = "https://graph.microsoft.com/v1.0"
    }
}

function Test-MicrosoftGraphModule {
    <#
    .SYNOPSIS
        Verifica si el módulo Microsoft.Graph está instalado
    #>
    return $null -ne (Get-Module -ListAvailable -Name Microsoft.Graph)
}

# Exportar funciones
Export-ModuleMember -Function @(
    'Test-IsOneDrivePath',
    'Get-OneDriveConfigFromUser',
    'Copy-LlevarLocalToOneDrive',
    'Copy-LlevarOneDriveToLocal',
    'Get-OneDriveAuth',
    'Test-MicrosoftGraphModule'
)