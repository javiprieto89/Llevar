# ========================================================================== #
#                  MÓDULO: CONFIGURACIÓN DE TRANSFERENCIA                    #
# ========================================================================== #
# Propósito: Objeto unificado para toda la configuración de transferencia
# Estructura jerárquica que evita mezcla de parámetros
# ========================================================================== #

# ========================================================================== #
#                     DEFINICIÓN DEL TIPO TRANSFERCONFIG                     #
# ========================================================================== #

class TransferConfig {
    # ====== ORIGEN ======
    [PSCustomObject]$Origen = [PSCustomObject]@{
        Tipo     = $null  # "Local", "FTP", "UNC", "OneDrive", "Dropbox", "USB"
        
        # Subestructura FTP
        FTP      = [PSCustomObject]@{
            Server    = $null
            Port      = 21
            User      = $null
            Password  = $null
            UseSsl    = $false
            Directory = "/"
        }
        
        # Subestructura UNC
        UNC      = [PSCustomObject]@{
            Path        = $null
            User        = $null
            Password    = $null
            Domain      = $null
            Credentials = $null
        }
        
        # Subestructura OneDrive
        OneDrive = [PSCustomObject]@{
            Path         = $null
            Token        = $null
            RefreshToken = $null
            Email        = $null
            ApiUrl       = "https://graph.microsoft.com/v1.0/me/drive"
        }
        
        # Subestructura Dropbox
        Dropbox  = [PSCustomObject]@{
            Path         = $null
            Token        = $null
            RefreshToken = $null
            Email        = $null
            ApiUrl       = "https://api.dropboxapi.com/2"
        }
        
        # Subestructura Local
        Local    = [PSCustomObject]@{
            Path = $null
        }
    }
    
    # ====== DESTINO ======
    [PSCustomObject]$Destino = [PSCustomObject]@{
        Tipo     = $null  # "Local", "USB", "FTP", "UNC", "OneDrive", "Dropbox", "ISO", "Diskette"
        
        # Subestructura FTP
        FTP      = [PSCustomObject]@{
            Server    = $null
            Port      = 21
            User      = $null
            Password  = $null
            UseSsl    = $false
            Directory = "/"
        }
        
        # Subestructura UNC
        UNC      = [PSCustomObject]@{
            Path        = $null
            User        = $null
            Password    = $null
            Domain      = $null
            Credentials = $null
        }
        
        # Subestructura OneDrive
        OneDrive = [PSCustomObject]@{
            Path         = $null
            Token        = $null
            RefreshToken = $null
            Email        = $null
            ApiUrl       = "https://graph.microsoft.com/v1.0/me/drive"
        }
        
        # Subestructura Dropbox
        Dropbox  = [PSCustomObject]@{
            Path         = $null
            Token        = $null
            RefreshToken = $null
            Email        = $null
            ApiUrl       = "https://api.dropboxapi.com/2"
        }
        
        # Subestructura Local
        Local    = [PSCustomObject]@{
            Path = $null
        }
        
        # Subestructura ISO
        ISO      = [PSCustomObject]@{
            OutputPath = $null
            Size       = "dvd"
            VolumeSize = $null
            VolumeName = "LLEVAR"
        }
        
        # Subestructura Diskette
        Diskette = [PSCustomObject]@{
            MaxDisks   = 30
            Size       = 1440
            OutputPath = $null
        }
    }
    
    # ====== OPCIONES GENERALES ======
    [PSCustomObject]$Opciones = [PSCustomObject]@{
        BlockSizeMB    = 10
        Clave          = $null
        UseNativeZip   = $false
        RobocopyMirror = $false
        TransferMode   = "Compress"
        Verbose        = $false
    }
    
    # ====== INTERNO (uso del sistema) ======
    [PSCustomObject]$Interno = [PSCustomObject]@{
        OrigenMontado  = $null
        DestinoMontado = $null
        OrigenDrive    = $null
        DestinoDrive   = $null
        TempDir        = $null
        SevenZipPath   = $null
    }
}

# ========================================================================== #
#                         FUNCIONES HELPER                                   #
# ========================================================================== #

function New-TransferConfig {
    <#
    .SYNOPSIS
        Crea un objeto de configuración unificado para transferencias
    .DESCRIPTION
        Crea una instancia del tipo TransferConfig con toda la estructura
        jerárquica inicializada. Este es el tipo de dato oficial para
        toda configuración de transferencia en LLEVAR.
    .OUTPUTS
        [TransferConfig] Objeto con estructura completa inicializada
    #>
    
    return [TransferConfig]::new()
}

function Set-TransferConfigOrigen {
    <#
    .SYNOPSIS
        Configura el origen en el objeto de transferencia
    .DESCRIPTION
        Cada tipo tiene su propia estructura de parámetros.
        No hay Path común - cada tipo define su ubicación de forma específica.
    .EXAMPLE
        Set-TransferConfigOrigen -Config $cfg -Tipo "FTP" -Parametros @{
            Server = "ftp.ejemplo.com"; Port = 21; User = "user"; Password = "pass"; Directory = "/datos"
        }
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config,
        
        [Parameter(Mandatory)]
        [ValidateSet("Local", "FTP", "UNC", "OneDrive", "Dropbox", "USB")]
        [string]$Tipo,
        
        [Parameter(Mandatory)]
        [hashtable]$Parametros
    )
    
    $Config.Origen.Tipo = $Tipo
    
    switch ($Tipo) {
        "FTP" {
            $Config.Origen.FTP.Server = $Parametros.Server
            $Config.Origen.FTP.Port = $Parametros.Port ?? 21
            $Config.Origen.FTP.User = $Parametros.User
            $Config.Origen.FTP.Password = $Parametros.Password
            $Config.Origen.FTP.UseSsl = $Parametros.UseSsl ?? $false
            $Config.Origen.FTP.Directory = $Parametros.Directory ?? "/"
        }
        "UNC" {
            $Config.Origen.UNC.Path = $Parametros.Path
            $Config.Origen.UNC.User = $Parametros.User
            $Config.Origen.UNC.Password = $Parametros.Password
            $Config.Origen.UNC.Domain = $Parametros.Domain
            $Config.Origen.UNC.Credentials = $Parametros.Credentials
        }
        "OneDrive" {
            $Config.Origen.OneDrive.Path = $Parametros.Path
            $Config.Origen.OneDrive.Token = $Parametros.Token
            $Config.Origen.OneDrive.RefreshToken = $Parametros.RefreshToken
            $Config.Origen.OneDrive.Email = $Parametros.Email
            if ($Parametros.ApiUrl) {
                $Config.Origen.OneDrive.ApiUrl = $Parametros.ApiUrl
            }
        }
        "Dropbox" {
            $Config.Origen.Dropbox.Path = $Parametros.Path
            $Config.Origen.Dropbox.Token = $Parametros.Token
            $Config.Origen.Dropbox.RefreshToken = $Parametros.RefreshToken
            $Config.Origen.Dropbox.Email = $Parametros.Email
            if ($Parametros.ApiUrl) {
                $Config.Origen.Dropbox.ApiUrl = $Parametros.ApiUrl
            }
        }
        { $_ -in "Local", "USB" } {
            $Config.Origen.Local.Path = $Parametros.Path
        }
    }
}

function Set-TransferConfigDestino {
    <#
    .SYNOPSIS
        Configura el destino en el objeto de transferencia
    .DESCRIPTION
        Cada tipo tiene su propia estructura de parámetros.
        No hay Path común - cada tipo define su ubicación de forma específica.
    .EXAMPLE
        Set-TransferConfigDestino -Config $cfg -Tipo "ISO" -Parametros @{
            OutputPath = "C:\ISOs"; Size = "dvd"; VolumeName = "Backup"
        }
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config,
        
        [Parameter(Mandatory)]
        [ValidateSet("Local", "USB", "FTP", "UNC", "OneDrive", "Dropbox", "ISO", "Diskette")]
        [string]$Tipo,
        
        [Parameter(Mandatory)]
        [hashtable]$Parametros
    )
    
    $Config.Destino.Tipo = $Tipo
    
    switch ($Tipo) {
        "FTP" {
            $Config.Destino.FTP.Server = $Parametros.Server
            $Config.Destino.FTP.Port = $Parametros.Port ?? 21
            $Config.Destino.FTP.User = $Parametros.User
            $Config.Destino.FTP.Password = $Parametros.Password
            $Config.Destino.FTP.UseSsl = $Parametros.UseSsl ?? $false
            $Config.Destino.FTP.Directory = $Parametros.Directory ?? "/"
        }
        "UNC" {
            $Config.Destino.UNC.Path = $Parametros.Path
            $Config.Destino.UNC.User = $Parametros.User
            $Config.Destino.UNC.Password = $Parametros.Password
            $Config.Destino.UNC.Domain = $Parametros.Domain
            $Config.Destino.UNC.Credentials = $Parametros.Credentials
        }
        "OneDrive" {
            $Config.Destino.OneDrive.Path = $Parametros.Path
            $Config.Destino.OneDrive.Token = $Parametros.Token
            $Config.Destino.OneDrive.RefreshToken = $Parametros.RefreshToken
            $Config.Destino.OneDrive.Email = $Parametros.Email
            if ($Parametros.ApiUrl) {
                $Config.Destino.OneDrive.ApiUrl = $Parametros.ApiUrl
            }
        }
        "Dropbox" {
            $Config.Destino.Dropbox.Path = $Parametros.Path
            $Config.Destino.Dropbox.Token = $Parametros.Token
            $Config.Destino.Dropbox.RefreshToken = $Parametros.RefreshToken
            $Config.Destino.Dropbox.Email = $Parametros.Email
            if ($Parametros.ApiUrl) {
                $Config.Destino.Dropbox.ApiUrl = $Parametros.ApiUrl
            }
        }
        "ISO" {
            $Config.Destino.ISO.OutputPath = $Parametros.OutputPath ?? $Parametros.Path
            $Config.Destino.ISO.Size = $Parametros.Size ?? $Parametros.IsoSize ?? "dvd"
            $Config.Destino.ISO.VolumeSize = $Parametros.VolumeSize
            $Config.Destino.ISO.VolumeName = $Parametros.VolumeName ?? "LLEVAR"
        }
        "Diskette" {
            $Config.Destino.Diskette.MaxDisks = $Parametros.MaxDisks ?? 30
            $Config.Destino.Diskette.OutputPath = $Parametros.OutputPath ?? $Parametros.Path
            if ($Parametros.Size) {
                $Config.Destino.Diskette.Size = $Parametros.Size
            }
        }
        { $_ -in "Local", "USB" } {
            $Config.Destino.Local.Path = $Parametros.Path
        }
    }
}

function Get-TransferConfigOrigen {
    <#
    .SYNOPSIS
        Obtiene la configuración del origen según su tipo
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config
    )
    
    # Fallback: infer tipo si no está establecido pero hay datos FTP/UNC/Local
    if (-not $Config.Origen.Tipo) {
        if ($Config.Origen.FTP.Server) { $Config.Origen.Tipo = "FTP" }
        elseif ($Config.Origen.UNC.Path) { $Config.Origen.Tipo = "UNC" }
        elseif ($Config.Origen.Local.Path) { $Config.Origen.Tipo = "Local" }
    }
    $tipo = $Config.Origen.Tipo
    if (-not $tipo) { Write-Host "DEBUG Get-TransferConfigOrigen: Tipo vacío" -ForegroundColor Yellow; return $null }
    $path = Get-TransferConfigOrigenPath -Config $Config
    
    $subConfig = switch ($tipo) {
        "FTP" { $Config.Origen.FTP }
        "UNC" { $Config.Origen.UNC }
        "OneDrive" { $Config.Origen.OneDrive }
        "Dropbox" { $Config.Origen.Dropbox }
        "Local" { $Config.Origen.Local }
        "USB" { $Config.Origen.Local }
        default { $null }
    }

    if (-not $subConfig) { return $null }

    $ht = [ordered]@{ Tipo = $tipo }
    foreach ($prop in $subConfig.PSObject.Properties) {
        $ht[$prop.Name] = $prop.Value
    }
    if ($path) { $ht["Path"] = $path }
    if ($tipo -in @("Local", "USB", "UNC")) { $ht["LocalPath"] = $path }
    return [pscustomobject]$ht
}

function Get-TransferConfigDestino {
    <#
    .SYNOPSIS
        Obtiene la configuración del destino según su tipo
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config
    )
    
    # Fallback: infer tipo si no está establecido pero hay datos FTP/UNC/Local
    if (-not $Config.Destino.Tipo) {
        if ($Config.Destino.FTP.Server) { $Config.Destino.Tipo = "FTP" }
        elseif ($Config.Destino.UNC.Path) { $Config.Destino.Tipo = "UNC" }
        elseif ($Config.Destino.Local.Path) { $Config.Destino.Tipo = "Local" }
    }
    $tipo = $Config.Destino.Tipo
    if (-not $tipo) { Write-Host "DEBUG Get-TransferConfigDestino: Tipo vacío" -ForegroundColor Yellow; return $null }
    $path = Get-TransferConfigDestinoPath -Config $Config
    
    $subConfig = switch ($tipo) {
        "FTP" { $Config.Destino.FTP }
        "UNC" { $Config.Destino.UNC }
        "OneDrive" { $Config.Destino.OneDrive }
        "Dropbox" { $Config.Destino.Dropbox }
        "ISO" { $Config.Destino.ISO }
        "Diskette" { $Config.Destino.Diskette }
        "Local" { $Config.Destino.Local }
        "USB" { $Config.Destino.Local }
        default { $null }
    }

    if (-not $subConfig) { return $null }

    $ht = [ordered]@{ Tipo = $tipo }
    foreach ($prop in $subConfig.PSObject.Properties) {
        $ht[$prop.Name] = $prop.Value
    }
    if ($path) { $ht["Path"] = $path }
    if ($tipo -in @("Local", "USB", "UNC")) { $ht["LocalPath"] = $path }
    return [pscustomobject]$ht
}

function Get-TransferConfigOrigenPath {
    <#
    .SYNOPSIS
        Obtiene el path efectivo del origen según su tipo
    .DESCRIPTION
        Construye una representación de ruta según el tipo:
        - Local/USB: Ruta del sistema
        - FTP: ftp://servidor:puerto/directorio
        - UNC: \\servidor\recurso
        - OneDrive/Dropbox: Ruta API o local
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config
    )
    
    $tipo = $Config.Origen.Tipo
    
    switch ($tipo) {
        "FTP" {
            $ftp = $Config.Origen.FTP
            $scheme = if ($ftp.UseSsl) { "ftps" } else { "ftp" }
            $server = $ftp.Server
            if ($server -match '^ftps?://(.+)$') { $server = $Matches[1] }
            return "${scheme}://${server}:$($ftp.Port)$($ftp.Directory)"
        }
        "UNC" {
            return $Config.Origen.UNC.Path
        }
        "OneDrive" {
            return $Config.Origen.OneDrive.Path
        }
        "Dropbox" {
            return $Config.Origen.Dropbox.Path
        }
        { $_ -in "Local", "USB" } {
            return $Config.Origen.Local.Path
        }
        default {
            return $null
        }
    }
}

function Get-TransferConfigDestinoPath {
    <#
    .SYNOPSIS
        Obtiene el path efectivo del destino según su tipo
    .DESCRIPTION
        Construye una representación de ruta según el tipo:
        - Local/USB: Ruta del sistema
        - FTP: ftp://servidor:puerto/directorio
        - UNC: \\servidor\recurso
        - OneDrive/Dropbox: Ruta API o local
        - ISO/Diskette: OutputPath
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config
    )
    
    $tipo = $Config.Destino.Tipo
    
    switch ($tipo) {
        "FTP" {
            $ftp = $Config.Destino.FTP
            $scheme = if ($ftp.UseSsl) { "ftps" } else { "ftp" }
            $server = $ftp.Server
            if ($server -match '^ftps?://(.+)$') { $server = $Matches[1] }
            return "${scheme}://${server}:$($ftp.Port)$($ftp.Directory)"
        }
        "UNC" {
            return $Config.Destino.UNC.Path
        }
        "OneDrive" {
            return $Config.Destino.OneDrive.Path
        }
        "Dropbox" {
            return $Config.Destino.Dropbox.Path
        }
        "ISO" {
            return $Config.Destino.ISO.OutputPath
        }
        "Diskette" {
            return $Config.Destino.Diskette.OutputPath
        }
        { $_ -in "Local", "USB" } {
            return $Config.Destino.Local.Path
        }
        default {
            return $null
        }
    }
}

function Test-TransferConfigComplete {
    <#
    .SYNOPSIS
        Valida que la configuración de transferencia esté completa
    .DESCRIPTION
        Verifica que cada tipo tenga sus parámetros requeridos configurados.
        No usa Path común - cada tipo tiene sus propios requisitos.
    #>
    param(
        [Parameter(Mandatory)]
        [TransferConfig]$Config
    )
    
    $errors = @()
    
    # Validar origen
    if (-not $Config.Origen.Tipo) {
        $errors += "Falta definir tipo de origen"
    }
    else {
        switch ($Config.Origen.Tipo) {
            "FTP" {
                if (-not $Config.Origen.FTP.Server) {
                    $errors += "Origen FTP: falta especificar servidor"
                }
                if (-not $Config.Origen.FTP.User) {
                    $errors += "Origen FTP: falta especificar usuario"
                }
            }
            "UNC" {
                if (-not $Config.Origen.UNC.Path) {
                    $errors += "Origen UNC: falta especificar ruta de red"
                }
            }
            "OneDrive" {
                if (-not $Config.Origen.OneDrive.Path) {
                    $errors += "Origen OneDrive: falta especificar ruta"
                }
                if (-not $Config.Origen.OneDrive.Token) {
                    $errors += "Origen OneDrive: falta autenticación (token)"
                }
            }
            "Dropbox" {
                if (-not $Config.Origen.Dropbox.Path) {
                    $errors += "Origen Dropbox: falta especificar ruta"
                }
                if (-not $Config.Origen.Dropbox.Token) {
                    $errors += "Origen Dropbox: falta autenticación (token)"
                }
            }
            { $_ -in "Local", "USB" } {
                if (-not $Config.Origen.Local.Path) {
                    $errors += "Origen $($Config.Origen.Tipo): falta especificar ruta"
                }
            }
        }
    }
    
    # Validar destino
    if (-not $Config.Destino.Tipo) {
        $errors += "Falta definir tipo de destino"
    }
    else {
        switch ($Config.Destino.Tipo) {
            "FTP" {
                if (-not $Config.Destino.FTP.Server) {
                    $errors += "Destino FTP: falta especificar servidor"
                }
                if (-not $Config.Destino.FTP.User) {
                    $errors += "Destino FTP: falta especificar usuario"
                }
            }
            "UNC" {
                if (-not $Config.Destino.UNC.Path) {
                    $errors += "Destino UNC: falta especificar ruta de red"
                }
            }
            "OneDrive" {
                if (-not $Config.Destino.OneDrive.Path) {
                    $errors += "Destino OneDrive: falta especificar ruta"
                }
                if (-not $Config.Destino.OneDrive.Token) {
                    $errors += "Destino OneDrive: falta autenticación (token)"
                }
            }
            "Dropbox" {
                if (-not $Config.Destino.Dropbox.Path) {
                    $errors += "Destino Dropbox: falta especificar ruta"
                }
                if (-not $Config.Destino.Dropbox.Token) {
                    $errors += "Destino Dropbox: falta autenticación (token)"
                }
            }
            "ISO" {
                if (-not $Config.Destino.ISO.OutputPath) {
                    $errors += "Destino ISO: falta especificar ruta de salida"
                }
            }
            "Diskette" {
                if (-not $Config.Destino.Diskette.OutputPath) {
                    $errors += "Destino Diskette: falta especificar ruta de salida"
                }
            }
            { $_ -in "Local", "USB" } {
                if (-not $Config.Destino.Local.Path) {
                    $errors += "Destino $($Config.Destino.Tipo): falta especificar ruta"
                }
            }
        }
    }
    
    return @{
        IsValid = ($errors.Count -eq 0)
        Errors  = $errors
    }
}

# Exportar funciones
Export-ModuleMember -Function @(
    'New-TransferConfig',
    'Set-TransferConfigOrigen',
    'Set-TransferConfigDestino',
    'Get-TransferConfigOrigen',
    'Get-TransferConfigDestino',
    'Get-TransferConfigOrigenPath',
    'Get-TransferConfigDestinoPath',
    'Test-TransferConfigComplete'
)
