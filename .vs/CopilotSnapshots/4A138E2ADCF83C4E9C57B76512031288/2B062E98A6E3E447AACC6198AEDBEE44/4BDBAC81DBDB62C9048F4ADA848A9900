# Importar clases de TransferConfig (using module debe estar al inicio)
using module "Q:\Utilidad\LLevar\Modules\Core\TransferConfig.psm1"

<#
.SYNOPSIS
    Maneja el modo normal de ejecución cuando no se usa ningún parámetro especial.

.DESCRIPTION
    Este módulo contiene toda la lógica del flujo principal de LLEVAR:
    - Validación de origen/destino
    - Montaje de rutas FTP/UNC/Cloud
    - Autenticación OneDrive/Dropbox
    - Selección de modo transferencia (Directo/Comprimido)
    - Compresión y división en bloques
    - Copia a USB/ISO/Cloud
    - Limpieza de temporales
#>

# Importar dependencias adicionales
$ModulesPath = Split-Path (Split-Path $PSScriptRoot -Parent) -Parent
Import-Module (Join-Path $ModulesPath "Modules\Utilities\PathSelectors.psm1") -Force -Global
Import-Module (Join-Path $ModulesPath "Modules\Transfer\Unified.psm1") -Force -Global

function Invoke-NormalMode {
    <#
    .SYNOPSIS
        Ejecuta el modo normal de LLEVAR con toda la lógica de transferencia.
    
    .PARAMETER TransferConfig
        Objeto de configuración unificado con toda la información de origen, destino y opciones.
        Debe ser creado con New-TransferConfig y configurado con Set-TransferConfigOrigen/Destino.
    
    .EXAMPLE
        $config = New-TransferConfig
        Set-TransferConfigOrigen -Config $config -Tipo "Local" -Parametros @{ Path = "C:\Data" }
        Set-TransferConfigDestino -Config $config -Tipo "USB" -Parametros @{ Path = "D:\USB" }
        Invoke-NormalMode -TransferConfig $config
    
    .EXAMPLE
        # Transferencia FTP a OneDrive
        $config = New-TransferConfig
        Set-TransferConfigOrigen -Config $config -Tipo "FTP" -Parametros @{ 
            Server = "ftp.example.com"; User = "user"; Password = "pass"; Directory = "/data" 
        }
        Set-TransferConfigDestino -Config $config -Tipo "OneDrive" -Parametros @{ Path = "/Backups" }
        Invoke-NormalMode -TransferConfig $config
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [TransferConfig]$TransferConfig
    )
    
    try {
        # Extraer valores del TransferConfig para uso local
        $BlockSizeMB = $TransferConfig.Opciones.BlockSizeMB
        $Clave = $TransferConfig.Opciones.Clave
        $UseNativeZip = $TransferConfig.Opciones.UseNativeZip
        
        # Determinar si el destino es ISO
        $esDestinoISO = ($TransferConfig.Destino.Tipo -eq "ISO")
        $IsoDestino = if ($esDestinoISO) { $TransferConfig.Destino.ISO.Size } else { "dvd" }
        
        # Validar si se forzó ZIP nativo
        if ($UseNativeZip) {
            if (-not (Test-Windows10OrLater)) {
                Write-Host ""
                Write-Host "ERROR: La compresión ZIP nativa requiere Windows 10 o superior." -ForegroundColor Red
                Write-Host ""
                Write-Host "Su versión de Windows: $([System.Environment]::OSVersion.Version)" -ForegroundColor Yellow
                Write-Host ""
                Write-Host "Opciones:" -ForegroundColor Cyan
                Write-Host "  1. Actualice a Windows 10 o superior" -ForegroundColor Gray
                Write-Host "  2. Quite el parámetro -UseNativeZip para usar 7-Zip automáticamente" -ForegroundColor Gray
                Write-Host "  3. Instale 7-Zip manualmente desde: https://www.7-zip.org/" -ForegroundColor Gray
                Write-Host ""
                return
            }
            Write-Host ""
            Write-Host "Usando compresión ZIP nativa de Windows (forzado por parámetro)" -ForegroundColor Cyan
            Write-Host "NOTA: ZIP nativo NO soporta contraseñas. El parámetro -Clave será ignorado." -ForegroundColor Yellow
            Write-Host ""
        }

        # Validar origen si viene del menú contextual o parámetros legacy
        $Origen = Get-TransferConfigOrigenPath -Config $TransferConfig
        $Destino = Get-TransferConfigDestinoPath -Config $TransferConfig
        
        if ($Origen) {
            # Solo validar paths locales con Test-Path
            if ($TransferConfig.Origen.Tipo -in @("Local", "USB")) {
                if (Test-Path $Origen) {
                    Show-Banner "ORIGEN PRESELECCIONADO DESDE MENÚ CONTEXTUAL" -BorderColor Cyan -TextColor Cyan
                    
                    $item = Get-Item $Origen
                    if ($item.PSIsContainer) {
                        Write-Host "Carpeta seleccionada: $Origen" -ForegroundColor Green
                    }
                    else {
                        Write-Host "Archivo seleccionado: $Origen" -ForegroundColor Green
                        Write-Host ""
                        Write-Host "NOTA: Se comprimirá el archivo individual." -ForegroundColor Yellow
                    }
                    Write-Host ""
                }
                else {
                    Write-Host ""
                    Write-Host "? El origen especificado no existe: $Origen" -ForegroundColor Yellow
                    Write-Host ""
                    $Origen = $null
                }
            }
            else {
                # Es FTP, OneDrive, Dropbox, UNC - mostrar configurado
                Write-Host "Origen $($TransferConfig.Origen.Tipo) configurado: $Origen" -ForegroundColor Green
            }
        }

        # Si no hay origen válido, pedirlo
        if (-not $Origen) {
            $Origen = Get-PathOrPrompt $Origen "ORIGEN"
            Set-TransferConfigOrigen -Config $TransferConfig -Tipo "Local" -Parametros @{ Path = $Origen }
        }
        
        # Si no hay destino válido, pedirlo
        if (-not $Destino) {
            $Destino = Get-PathOrPrompt $Destino "DESTINO"
            Set-TransferConfigDestino -Config $TransferConfig -Tipo "Local" -Parametros @{ Path = $Destino }
        }

        # ========================================================================== #
        #              VALIDACIÓN DE ORIGEN Y DESTINO DESDE TRANSFERCONFIG           #
        # ========================================================================== #
        
        # Validar que tipo de origen esté definido
        if (-not $TransferConfig.Origen.Tipo) {
            Write-Host ""
            Write-Host "╔═══════════════════════════════════════╗" -ForegroundColor Red
            Write-Host "║  ⚠ FALTA DEFINIR ORIGEN               ║" -ForegroundColor Red
            Write-Host "╚═══════════════════════════════════════╝" -ForegroundColor Red
            Write-Host ""
            Write-Host "Debe configurar el origen antes de ejecutar la transferencia." -ForegroundColor Yellow
            Write-Host ""
            return
        }
        
        # Validar que tipo de destino esté definido
        if (-not $TransferConfig.Destino.Tipo) {
            Write-Host ""
            Write-Host "╔═══════════════════════════════════════╗" -ForegroundColor Red
            Write-Host "║  ⚠ FALTA DEFINIR DESTINO              ║" -ForegroundColor Red
            Write-Host "╚═══════════════════════════════════════╝" -ForegroundColor Red
            Write-Host ""
            Write-Host "Debe configurar el destino antes de ejecutar la transferencia." -ForegroundColor Yellow
            Write-Host ""
            return
        }
        
        # Determinar tipos desde TransferConfig
        $origenEsFtp = ($TransferConfig.Origen.Tipo -eq "FTP")
        $destinoEsFtp = ($TransferConfig.Destino.Tipo -eq "FTP")
        $origenEsOneDrive = ($TransferConfig.Origen.Tipo -eq "OneDrive")
        $destinoEsOneDrive = ($TransferConfig.Destino.Tipo -eq "OneDrive")
        $origenEsDropbox = ($TransferConfig.Origen.Tipo -eq "Dropbox")
        $destinoEsDropbox = ($TransferConfig.Destino.Tipo -eq "Dropbox")
        
        # Si alguno es FTP, OneDrive o Dropbox, preguntar modo de transferencia
        $TransferMode = "Compress" # Por defecto comprimir
        if ($origenEsFtp -or $destinoEsFtp -or $origenEsOneDrive -or $destinoEsOneDrive -or $origenEsDropbox -or $destinoEsDropbox) {
            $tipoTransfer = "FTP"
            if ($origenEsOneDrive -or $destinoEsOneDrive) { $tipoTransfer = "OneDrive/FTP" }
            if ($origenEsDropbox -or $destinoEsDropbox) { $tipoTransfer = "Dropbox/OneDrive/FTP" }
            
            $mensaje = @"
¿Cómo desea realizar la transferencia?

• Transferir Directamente: Copia archivos sin comprimir
• Comprimir Primero: Comprime, divide en bloques y transfiere (genera INSTALAR.ps1)

Nota: Si elige comprimir, los archivos temporales se eliminarán automáticamente.
"@
            
            $opciones = @("*Transferir Directamente", "*Comprimir Primero")
            # DefaultIndex es base 0: 0=Directo, 1=Comprimir (dejamos Directo por defecto)
            $seleccion = Show-ConsolePopup -Title "Modo de Transferencia $tipoTransfer" -Message $mensaje -Options $opciones -DefaultIndex 0

            $TransferMode = if ($seleccion -eq 0) { "Direct" } else { "Compress" }
            Write-Host "Modo seleccionado: $TransferMode" -ForegroundColor Cyan
        }
        
        # Autenticar con OneDrive si es necesario
        if ($origenEsOneDrive -or $destinoEsOneDrive) {
            if (-not (Test-MicrosoftGraphModule)) {
                Write-Host ""
                Write-Host "✗ No se pueden usar funciones de OneDrive sin los módulos Microsoft.Graph" -ForegroundColor Red
                Write-Host ""
                return
            }
            
            Show-Banner "AUTENTICACIÓN ONEDRIVE" -BorderColor Cyan -TextColor Yellow
            
            if (-not (Connect-GraphSession)) {
                Write-Host "No se pudo autenticar con OneDrive. Cancelando." -ForegroundColor Red
                return
            }
        }
        
        # Autenticar con Dropbox si es necesario
        if ($origenEsDropbox -or $destinoEsDropbox) {
            Show-Banner "AUTENTICACIÓN DROPBOX" -BorderColor Cyan -TextColor Yellow
            
            if (-not (Connect-DropboxSession)) {
                Write-Host "No se pudo autenticar con Dropbox. Cancelando." -ForegroundColor Red
                return
            }
        }

        # Procesar rutas especiales (UNC, FTP, OneDrive, Dropbox)
        $result = Initialize-TransferPaths -Origen $Origen -Destino $Destino `
            -OrigenEsOneDrive $origenEsOneDrive -DestinoEsOneDrive $destinoEsOneDrive `
            -OrigenEsDropbox $origenEsDropbox -DestinoEsDropbox $destinoEsDropbox `
            -OrigenEsFtp $origenEsFtp -DestinoEsFtp $destinoEsFtp `
            -TransferConfig $TransferConfig
        
        if (-not $result) {
            $msg = "Error inicializando rutas de transferencia.`n`n" + `
                "Origen:  $Origen`nDestino: $Destino`n`n" + `
                "Revise credenciales, conectividad o permisos de red."
            Show-ConsolePopup -Title "Error de Transferencia" -Message $msg -Options @("*OK") | Out-Null
            return
        }
        
        $origenMontado = $result.OrigenMontado
        $destinoMontado = $result.DestinoMontado
        $origenDrive = $result.OrigenDrive
        $destinoDrive = $result.DestinoDrive

        # Determinar método de compresión
        if ($UseNativeZip) {
            $SevenZ = "NATIVE_ZIP"
        }
        else {
            $SevenZ = Get-SevenZipLlevar
        }

        $Temp = Join-Path $env:TEMP "LLEVAR_TEMP"
        if (-not (Test-Path $Temp)) { 
            New-Item -Type Directory $Temp | Out-Null 
        }

        # Validar que el destino sea escribible (solo para rutas locales)
        if (-not $destinoEsFtp -and -not $destinoEsOneDrive -and -not $destinoEsDropbox) {
            if (-not (Test-PathWritable -Path $destinoMontado)) {
                Write-Host "Destino no es escribible. Cancelando." -ForegroundColor Red
                Clear-TransferPaths -OrigenDrive $origenDrive -DestinoDrive $destinoDrive
                return
            }
        }

        # El destino ISO ya está determinado en línea 82 desde TransferConfig
        # Modo ISO (solo si el destino es realmente ISO)
        if ($esDestinoISO) {
            New-LlevarIsoMain -Origen $origenMontado -Destino $destinoMontado -Temp $Temp -SevenZ $SevenZ -BlockSizeMB $BlockSizeMB -Clave $Clave -IsoDestino $IsoDestino
            Clear-TransferPaths -OrigenDrive $origenDrive -DestinoDrive $destinoDrive
            return
        }

        # Ejecutar transferencia según el modo seleccionado
        if ($TransferMode -eq "Direct") {
            Invoke-DirectTransfer -TransferConfig $TransferConfig -OrigenMontado $origenMontado -DestinoMontado $destinoMontado `
                -OrigenEsFtp $origenEsFtp -DestinoEsFtp $destinoEsFtp `
                -OrigenEsOneDrive $origenEsOneDrive -DestinoEsOneDrive $destinoEsOneDrive `
                -OrigenEsDropbox $origenEsDropbox -DestinoEsDropbox $destinoEsDropbox
            
            Clear-TransferPaths -OrigenDrive $origenDrive -DestinoDrive $destinoDrive
            Write-Host "`n✓ Finalizado (Modo Directo)."
            return
        }

        # Modo Compresión y Transferencia
        Invoke-CompressedTransfer -TransferConfig $TransferConfig -OrigenMontado $origenMontado -DestinoMontado $destinoMontado `
            -Temp $Temp -SevenZ $SevenZ -Clave $Clave -BlockSizeMB $BlockSizeMB `
            -OrigenEsOneDrive $origenEsOneDrive -DestinoEsOneDrive $destinoEsOneDrive `
            -OrigenEsDropbox $origenEsDropbox -DestinoEsDropbox $destinoEsDropbox `
            -DestinoEsFtp $destinoEsFtp
        
        Clear-TransferPaths -OrigenDrive $origenDrive -DestinoDrive $destinoDrive -TempDir $Temp
        Write-Host "`n✓ Finalizado (Modo Comprimido)."
    }
    catch {
        Write-ErrorLog "Error en modo normal de ejecución." $_
        Write-Host "Ocurrió un error. Revise el log en: $Global:LogFile" -ForegroundColor Red
    }
}

# Función auxiliar para inicializar rutas de transferencia
function Initialize-TransferPaths {
    param(
        $Origen, $Destino,
        $OrigenEsOneDrive, $DestinoEsOneDrive,
        $OrigenEsDropbox, $DestinoEsDropbox,
        $OrigenEsFtp, $DestinoEsFtp,
        [TransferConfig]$TransferConfig
    )
    
    $origenMontado = $Origen
    $destinoMontado = $Destino
    $origenDrive = $null
    $destinoDrive = $null
    
    # Manejar origen OneDrive
    if ($OrigenEsOneDrive) {
        Write-Host "Configurando origen OneDrive..." -ForegroundColor Cyan
        if ($Origen -match '^onedrive://(.+)$' -or $Origen -match '^ONEDRIVE:(.+)$') {
            $origenMontado = $Matches[1]
        }
        else {
            Write-Host "Ingrese la ruta en OneDrive (ejemplo: /Documentos/MiCarpeta): " -NoNewline
            $origenMontado = Read-Host
        }
        Write-Host "✓ Origen OneDrive configurado: $origenMontado" -ForegroundColor Green
    }
    # Manejar origen Dropbox
    elseif ($OrigenEsDropbox) {
        Write-Host "Configurando origen Dropbox..." -ForegroundColor Cyan
        if ($Origen -match '^dropbox://(.+)$' -or $Origen -match '^DROPBOX:(.+)$') {
            $origenMontado = $Matches[1]
        }
        else {
            Write-Host "Ingrese la ruta en Dropbox (ejemplo: /Documentos/MiCarpeta): " -NoNewline
            $origenMontado = Read-Host
        }
        Write-Host "✓ Origen Dropbox configurado: $origenMontado" -ForegroundColor Green
    }
    elseif ($Origen -match '^\\\\' -or $OrigenEsFtp) {
        $tipoOrigen = if ($OrigenEsFtp) { "FTP" } else { "UNC" }
        Write-Host "Montando ruta $tipoOrigen de origen..." -ForegroundColor Cyan
        $origenDrive = "LLEVAR_ORIGEN"
        try {
            # Obtener credenciales desde TransferConfig
            $credOrigen = $null
            if ($OrigenEsFtp -and $TransferConfig.Origen.FTP.User) {
                $securePass = ConvertTo-SecureString $TransferConfig.Origen.FTP.Password -AsPlainText -Force
                $credOrigen = New-Object System.Management.Automation.PSCredential($TransferConfig.Origen.FTP.User, $securePass)
            }
            elseif ($TransferConfig.Origen.UNC.Credentials) {
                $credOrigen = $TransferConfig.Origen.UNC.Credentials
            }
            
            $origenMontado = Mount-LlevarNetworkPath -Path $Origen -Credential $credOrigen -DriveName $origenDrive
            Write-Host "✓ Origen montado: $origenMontado" -ForegroundColor Green
        }
        catch {
            Write-Host "Error al montar origen: $($_.Exception.Message)" -ForegroundColor Red
            return $null
        }
    }
    
    # Manejar destino OneDrive
    if ($DestinoEsOneDrive) {
        Write-Host "Configurando destino OneDrive..." -ForegroundColor Cyan
        if ($Destino -match '^onedrive://(.+)$' -or $Destino -match '^ONEDRIVE:(.+)$') {
            $destinoMontado = $Matches[1]
        }
        else {
            Write-Host "Ingrese la ruta en OneDrive (ejemplo: /Documentos/Destino): " -NoNewline
            $destinoMontado = Read-Host
        }
        Write-Host "✓ Destino OneDrive configurado: $destinoMontado" -ForegroundColor Green
    }
    # Manejar destino Dropbox
    elseif ($DestinoEsDropbox) {
        Write-Host "Configurando destino Dropbox..." -ForegroundColor Cyan
        if ($Destino -match '^dropbox://(.+)$' -or $Destino -match '^DROPBOX:(.+)$') {
            $destinoMontado = $Matches[1]
        }
        else {
            Write-Host "Ingrese la ruta en Dropbox (ejemplo: /Documentos/Destino): " -NoNewline
            $destinoMontado = Read-Host
        }
        Write-Host "✓ Destino Dropbox configurado: $destinoMontado" -ForegroundColor Green
    }
    elseif ($Destino -match '^\\\\' -or $DestinoEsFtp) {
        $tipoDestino = if ($DestinoEsFtp) { "FTP" } else { "UNC" }
        Write-Host "Montando ruta $tipoDestino de destino..." -ForegroundColor Cyan
        $destinoDrive = "LLEVAR_DESTINO"
        try {
            # Obtener credenciales desde TransferConfig
            $credDestino = $null
            if ($DestinoEsFtp -and $TransferConfig.Destino.FTP.User) {
                $securePass = ConvertTo-SecureString $TransferConfig.Destino.FTP.Password -AsPlainText -Force
                $credDestino = New-Object System.Management.Automation.PSCredential($TransferConfig.Destino.FTP.User, $securePass)
            }
            elseif ($TransferConfig.Destino.UNC.Credentials) {
                $credDestino = $TransferConfig.Destino.UNC.Credentials
            }
            
            $destinoMontado = Mount-LlevarNetworkPath -Path $Destino -Credential $credDestino -DriveName $destinoDrive
            Write-Host "✓ Destino montado: $destinoMontado" -ForegroundColor Green
        }
        catch {
            Write-Host "Error al montar destino: $($_.Exception.Message)" -ForegroundColor Red
            if ($origenDrive -and (Get-PSDrive -Name $origenDrive -ErrorAction SilentlyContinue)) {
                Remove-PSDrive -Name $origenDrive -Force -ErrorAction SilentlyContinue
            }
            return $null
        }
    }
    
    return @{
        OrigenMontado  = $origenMontado
        DestinoMontado = $destinoMontado
        OrigenDrive    = $origenDrive
        DestinoDrive   = $destinoDrive
    }
}

# Función auxiliar para transferencia directa
function Invoke-DirectTransfer {
    param(
        [TransferConfig]$TransferConfig,
        $OrigenMontado, $DestinoMontado,
        $OrigenEsFtp, $DestinoEsFtp, $OrigenEsOneDrive, $DestinoEsOneDrive,
        $OrigenEsDropbox, $DestinoEsDropbox
    )
    
    Write-Host "`nIniciando transferencia directa..." -ForegroundColor Cyan
    
    try {
        # Usar TransferConfig directamente
        Write-Log "Usando TransferConfig para Copy-LlevarFiles" "INFO"
        
        $useRobocopy = $false
        if ($TransferConfig.Origen.Tipo -eq "Local" -and $TransferConfig.Destino.Tipo -in @("Local", "UNC")) {
            $useRobocopy = $TransferConfig.Opciones.RobocopyMirror -or $false
        }
        
        # Construir sub-configs desde TransferConfig
        $sourceConfig = Get-TransferConfigOrigen -Config $TransferConfig
        $destConfig = Get-TransferConfigDestino -Config $TransferConfig

        # IMPORTANTE: Convertir PSCustomObject a Hashtable si es necesario
        if ($sourceConfig -is [PSCustomObject]) {
            $tempSource = @{}
            $sourceConfig.PSObject.Properties | ForEach-Object {
                $tempSource[$_.Name] = $_.Value
            }
            $sourceConfig = $tempSource
        }
        
        if ($destConfig -is [PSCustomObject]) {
            $tempDest = @{}
            $destConfig.PSObject.Properties | ForEach-Object {
                $tempDest[$_.Name] = $_.Value
            }
            $destConfig = $tempDest
        }

        Write-Log "DEBUG: TransferConfig.Origen.Tipo=$($TransferConfig.Origen.Tipo) Destino.Tipo=$($TransferConfig.Destino.Tipo)" "INFO"
        Write-Log "DEBUG: SourceConfig type=$(($sourceConfig.GetType()).Name)" "INFO"
        Write-Log "DEBUG: DestConfig type=$(($destConfig.GetType()).Name)" "INFO"
        Write-Host "DEBUG Origen: $($sourceConfig.Tipo) -> $($sourceConfig.Path)" -ForegroundColor Yellow
        Write-Host "DEBUG Destino: $($destConfig.Tipo) -> $($destConfig.Path)" -ForegroundColor Yellow
        
        $copyResult = Copy-LlevarFiles -SourceConfig $sourceConfig -DestinationConfig $destConfig `
            -SourcePath $OrigenMontado -ShowProgress $true -ProgressTop -1 `
            -UseRobocopy $useRobocopy -RobocopyMirror $TransferConfig.Opciones.RobocopyMirror
        
        Show-Banner "✓ TRANSFERENCIA COMPLETADA" -BorderColor Green -TextColor Green
        Write-Host "Archivos copiados: $($copyResult.FileCount)" -ForegroundColor White
        Write-Host "Bytes transferidos: $([Math]::Round($copyResult.BytesCopied/1MB, 2)) MB" -ForegroundColor White
        Write-Host "Tiempo transcurrido: $([Math]::Round($copyResult.ElapsedSeconds, 2)) segundos" -ForegroundColor White
        Write-Host ""
        
        Write-Host "✓ Transferencia directa completada." -ForegroundColor Green
    }
    catch {
        Write-Host "Error durante transferencia directa: $($_.Exception.Message)" -ForegroundColor Red
        Write-ErrorLog "Error en transferencia directa" $_
    }
}

# Función auxiliar para transferencia comprimida
function Invoke-CompressedTransfer {
    param(
        [TransferConfig]$TransferConfig,
        $OrigenMontado, $DestinoMontado, $Temp, $SevenZ, $Clave, $BlockSizeMB,
        $OrigenEsOneDrive, $DestinoEsOneDrive, $OrigenEsDropbox, $DestinoEsDropbox,
        $DestinoEsFtp
    )    
    Write-Host "`nIniciando compresión y transferencia..." -ForegroundColor Cyan
    
    # Si origen es OneDrive o Dropbox, descargar primero a temporal
    $origenParaComprimir = $OrigenMontado
    $tempOrigenCloud = $null
    
    if ($OrigenEsOneDrive) {
        Write-Host "Descargando desde OneDrive a carpeta temporal..." -ForegroundColor Cyan
        $tempOrigenCloud = Join-Path $env:TEMP "LLEVAR_ONEDRIVE_ORIGEN"
        if (Test-Path $tempOrigenCloud) {
            Remove-Item $tempOrigenCloud -Recurse -Force
        }
        New-Item -Type Directory $tempOrigenCloud | Out-Null
        
        Receive-OneDriveFolder -OneDrivePath "root:${OrigenMontado}:" -LocalFolder $tempOrigenCloud
        $origenParaComprimir = $tempOrigenCloud
    }
    elseif ($OrigenEsDropbox) {
        Write-Host "Descargando desde Dropbox a carpeta temporal..." -ForegroundColor Cyan
        $tempOrigenCloud = Join-Path $env:TEMP "LLEVAR_DROPBOX_ORIGEN"
        if (Test-Path $tempOrigenCloud) {
            Remove-Item $tempOrigenCloud -Recurse -Force
        }
        New-Item -Type Directory $tempOrigenCloud | Out-Null
        
        Receive-DropboxFolder -RemotePath $OrigenMontado -LocalFolder $tempOrigenCloud -Token $Global:DropboxToken
        $origenParaComprimir = $tempOrigenCloud
    }
    
    $compressionResult = Compress-Folder $origenParaComprimir $Temp $SevenZ $Clave $BlockSizeMB $DestinoMontado
    $blocks = $compressionResult.Files
    $compressionType = $compressionResult.CompressionType

    # No pasar destino al instalador - dejarlo que use el directorio actual por defecto
    $installerScript = New-InstallerScript -Temp $Temp -CompressionType $compressionType

    # Si destino es OneDrive o Dropbox, subir bloques
    if ($DestinoEsOneDrive) {
        Send-ToOneDrive -Blocks $blocks -InstallerScript $installerScript -SevenZ $SevenZ `
            -CompressionType $compressionType -DestinoMontado $DestinoMontado
    }
    elseif ($DestinoEsDropbox) {
        Send-ToDropbox -Blocks $blocks -InstallerScript $installerScript -SevenZ $SevenZ `
            -CompressionType $compressionType -DestinoMontado $DestinoMontado
    }
    elseif ($TransferConfig.Destino.Tipo -eq "Diskette") {
        $floppySuccess = Copy-ToFloppyDisks `
            -SourcePath $origenParaComprimir `
            -TempDir $Temp `
            -SevenZPath $SevenZ `
            -Password $Clave `
            -VerifyDisks
        
        if (-not $floppySuccess) {
            Write-Host "✗ Error copiando a diskettes" -ForegroundColor Red
            return
        }
    }
    else {
        Copy-BlocksToUSB -Blocks $blocks -InstallerPath $installerScript -SevenZPath $SevenZ `
            -CompressionType $compressionType -DestinationPath $DestinoMontado -IsFtp $DestinoEsFtp
    }
    
    # Limpiar temporal de cloud origen si existe
    if ($tempOrigenCloud -and (Test-Path $tempOrigenCloud)) {
        Write-Host "`nLimpiando descarga temporal de cloud..." -ForegroundColor Cyan
        Remove-Item $tempOrigenCloud -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# Función auxiliar para subir a OneDrive
function Send-ToOneDrive {
    param($Blocks, $InstallerScript, $SevenZ, $CompressionType, $DestinoMontado)
    
    Write-Host "`nSubiendo bloques a OneDrive..." -ForegroundColor Cyan
    
    $totalBlocks = $Blocks.Count
    $currentBlock = 0
    
    foreach ($block in $Blocks) {
        $currentBlock++
        $fileName = [System.IO.Path]::GetFileName($block)
        Write-Host "[$currentBlock/$totalBlocks] Subiendo: $fileName" -ForegroundColor Gray
        Send-OneDriveFile -LocalPath $block -RemotePath $DestinoMontado
    }
    
    if ($InstallerScript -and (Test-Path $InstallerScript)) {
        Write-Host "Subiendo INSTALAR.ps1..." -ForegroundColor Gray
        Send-OneDriveFile -LocalPath $InstallerScript -RemotePath $DestinoMontado
    }
    
    if ($SevenZ -and $CompressionType -ne "NATIVE_ZIP" -and (Test-Path $SevenZ)) {
        Write-Host "Subiendo 7z.exe..." -ForegroundColor Gray
        Send-OneDriveFile -LocalPath $SevenZ -RemotePath $DestinoMontado
    }
    
    Write-Host "`n✓ Todos los archivos subidos a OneDrive" -ForegroundColor Green
}

# Función auxiliar para subir a Dropbox
function Send-ToDropbox {
    param($Blocks, $InstallerScript, $SevenZ, $CompressionType, $DestinoMontado)
    
    Write-Host "`nSubiendo bloques a Dropbox..." -ForegroundColor Cyan
    
    $totalBlocks = $Blocks.Count
    $currentBlock = 0
    
    foreach ($block in $Blocks) {
        $currentBlock++
        $fileName = [System.IO.Path]::GetFileName($block)
        $remotePath = "$DestinoMontado/$fileName".Replace('//', '/')
        Write-Host "[$currentBlock/$totalBlocks] Subiendo: $fileName" -ForegroundColor Gray
        Send-DropboxFile -LocalPath $block -RemotePath $remotePath -Token $Global:DropboxToken
    }
    
    if ($InstallerScript -and (Test-Path $InstallerScript)) {
        Write-Host "Subiendo INSTALAR.ps1..." -ForegroundColor Gray
        $installerName = [System.IO.Path]::GetFileName($InstallerScript)
        $remotePath = "$DestinoMontado/$installerName".Replace('//', '/')
        Send-DropboxFile -LocalPath $InstallerScript -RemotePath $remotePath -Token $Global:DropboxToken
    }
    
    if ($SevenZ -and $CompressionType -ne "NATIVE_ZIP" -and (Test-Path $SevenZ)) {
        Write-Host "Subiendo 7z.exe..." -ForegroundColor Gray
        $remotePath = "$DestinoMontado/7z.exe".Replace('//', '/')
        Send-DropboxFile -LocalPath $SevenZ -RemotePath $remotePath -Token $Global:DropboxToken
    }
    
    Write-Host "`n✓ Todos los archivos subidos a Dropbox" -ForegroundColor Green
}

# Función auxiliar para limpiar rutas y temporales
function Clear-TransferPaths {
    param($OrigenDrive, $DestinoDrive, $TempDir)
    
    if ($OrigenDrive -and (Get-PSDrive -Name $OrigenDrive -ErrorAction SilentlyContinue)) {
        Remove-PSDrive -Name $OrigenDrive -Force -ErrorAction SilentlyContinue
    }
    if ($DestinoDrive -and (Get-PSDrive -Name $DestinoDrive -ErrorAction SilentlyContinue)) {
        Remove-PSDrive -Name $DestinoDrive -Force -ErrorAction SilentlyContinue
    }
    
    if ($TempDir) {
        Write-Host "`nLimpiando archivos temporales..." -ForegroundColor Cyan
        try {
            if (Test-Path $TempDir) {
                Remove-Item -Path $TempDir -Recurse -Force -ErrorAction Stop
                Write-Host "✓ Archivos temporales eliminados de: $TempDir" -ForegroundColor Green
            }
        }
        catch {
            Write-Host "Advertencia: No se pudieron eliminar algunos archivos temporales: $($_.Exception.Message)" -ForegroundColor Yellow
            Write-ErrorLog "Error al limpiar archivos temporales" $_
        }
    }
}

Export-ModuleMember -Function Invoke-NormalMode